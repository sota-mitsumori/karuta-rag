<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>シェアされた会話 - 競技かるたRAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'media' }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <style>
      html, body { height: 100%; margin: 0; }
      .share-layout {
        height: 100dvh;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .share-scroll {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .markdown-body p { margin: 0.5em 0; }
      .markdown-body p:first-child { margin-top: 0; }
      .markdown-body p:last-child { margin-bottom: 0; }
      .markdown-body ul, .markdown-body ol { margin: 0.5em 0; padding-left: 1.5em; }
      .markdown-body li { margin: 0.25em 0; }
      .markdown-body strong { font-weight: 600; }
      .markdown-body code { font-size: 0.9em; padding: 0.15em 0.35em; border-radius: 4px; background: rgba(0,0,0,0.06); }
      .dark .markdown-body code { background: rgba(255,255,255,0.1); }
      .markdown-body pre { margin: 0.5em 0; padding: 0.75em; border-radius: 8px; overflow-x: auto; background: rgba(0,0,0,0.04); }
      .dark .markdown-body pre { background: rgba(255,255,255,0.06); }
      .markdown-body pre code { padding: 0; background: none; }
    </style>
  </head>
  <body class="bg-zinc-50 dark:bg-zinc-900 text-zinc-900 dark:text-zinc-50 share-layout">
    <header class="shrink-0 border-b border-zinc-200 dark:border-zinc-800 bg-white/95 dark:bg-zinc-900/95 backdrop-blur px-3 sm:px-4 py-2 sm:py-3">
      <div class="max-w-3xl mx-auto">
        <h1 class="text-sm sm:text-lg font-semibold">競技かるたRAG - シェアされた会話</h1>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">公式ルールに基づくQ&Aの記録です</p>
      </div>
    </header>

    <div id="content" class="flex-1 min-h-0 flex flex-col max-w-3xl w-full mx-auto px-3 sm:px-4">
      {% if error %}
      <div class="share-scroll py-6">
        <p class="text-zinc-600 dark:text-zinc-400">このリンクは無効か、期限切れです。</p>
      </div>
      {% else %}
      <div id="conversation" class="share-scroll space-y-4 py-3"></div>
      {% endif %}

      <footer class="shrink-0 border-t border-zinc-200 dark:border-zinc-800 py-3 mt-auto">
        <a href="/" class="text-sm text-zinc-600 dark:text-zinc-400 hover:underline">← チャットで質問する</a>
      </footer>
    </div>

    <script id="share-data" type="application/json">{{ (messages if not error else []) | tojson }}</script>
    <script>
      (function() {
        var el = document.getElementById("share-data");
        var messages = el ? JSON.parse(el.textContent) : [];
        var container = document.getElementById("conversation");
        if (!container || !Array.isArray(messages) || messages.length === 0) return;

        function escapeHtml(str) {
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }
        function renderMarkdown(text) {
          var raw = String(text || "").trim();
          if (!raw) return "";
          if (typeof marked === "undefined" || typeof DOMPurify === "undefined")
            return escapeHtml(raw).replace(/\n/g, "<br>");
          var html = (marked.parse || marked)(raw, { gfm: true, breaks: true });
          return DOMPurify.sanitize(html, { ALLOWED_TAGS: ["p","br","strong","em","code","pre","ul","ol","li","h1","h2","h3","a","blockquote"] });
        }

        messages.forEach(function(m) {
          var q = (m.question || "").trim();
          var a = (m.answer || "").trim();

          var userWrap = document.createElement("div");
          userWrap.className = "flex justify-end";
          userWrap.innerHTML = '<div class="max-w-[85%] sm:max-w-[80%] rounded-2xl bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 px-3 py-2 text-sm shadow">' +
            '<div>' + escapeHtml(q) + '</div></div>';
          container.appendChild(userWrap);

          var asstWrap = document.createElement("div");
          asstWrap.className = "flex justify-start";
          var asstInner = '<div class="flex items-start gap-2 max-w-[85%] sm:max-w-[80%]">' +
            '<div class="mt-1 h-6 w-6 shrink-0 rounded-full bg-zinc-900 dark:bg-zinc-100 text-xs flex items-center justify-center text-white dark:text-zinc-900">K</div>' +
            '<div class="markdown-body rounded-2xl bg-zinc-100 dark:bg-zinc-800 px-3 py-2 text-sm text-zinc-900 dark:text-zinc-50">' +
            (renderMarkdown(a) || escapeHtml(a)) + '</div></div>';
          asstWrap.innerHTML = asstInner;
          container.appendChild(asstWrap);
        });
      })();
    </script>
  </body>
</html>
