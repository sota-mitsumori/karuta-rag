<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>競技かるたRAG Chat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown: marked + DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'media',
      }
    </script>
    <style>
      /* スマホで入力エリアを常に画面最下部に固定。チャット部分だけスクロール */
      html, body { height: 100%; margin: 0; }
      .chat-layout {
        height: 100dvh;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .chat-scroll {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
      }
      .safe-area-padding { padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
      .safe-area-padding-bottom { padding-bottom: max(env(safe-area-inset-bottom), 8px); }
      /* Markdown コンテンツ用 */
      .markdown-body p { margin: 0.5em 0; }
      .markdown-body p:first-child { margin-top: 0; }
      .markdown-body p:last-child { margin-bottom: 0; }
      .markdown-body ul, .markdown-body ol { margin: 0.5em 0; padding-left: 1.5em; }
      .markdown-body li { margin: 0.25em 0; }
      .markdown-body strong { font-weight: 600; }
      .markdown-body code { font-size: 0.9em; padding: 0.15em 0.35em; border-radius: 4px; background: rgba(0,0,0,0.06); }
      .dark .markdown-body code { background: rgba(255,255,255,0.1); }
      .markdown-body pre { margin: 0.5em 0; padding: 0.75em; border-radius: 8px; overflow-x: auto; background: rgba(0,0,0,0.04); }
      .dark .markdown-body pre { background: rgba(255,255,255,0.06); }
      .markdown-body pre code { padding: 0; background: none; }
    </style>
  </head>
  <body class="bg-zinc-50 dark:bg-zinc-900 text-zinc-900 dark:text-zinc-50 chat-layout">
    <header class="shrink-0 border-b border-zinc-200 dark:border-zinc-800 bg-white/95 dark:bg-zinc-900/95 backdrop-blur safe-area-padding">
      <div class="max-w-3xl mx-auto px-3 sm:px-4 py-2 sm:py-3">
        <h1 class="text-sm sm:text-lg font-semibold">競技かるたの競技規定ならびに競技会規定に関するChatBot</h1>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">
          公式ルールの内容に基づいて回答します
        </p>
      </div>
    </header>

    <!-- チャットエリア（ここだけスクロール）＋ 入力は常に下部 -->
    <div class="flex-1 min-h-0 flex flex-col max-w-3xl w-full mx-auto px-3 sm:px-4">
      <div
        id="chat"
        class="chat-scroll space-y-4 py-3 pb-2"
      >
        <div id="chat-placeholder" class="text-xs text-zinc-400 dark:text-zinc-500 text-center py-4">
          競技かるたのルールに関する質問をどうぞ。
        </div>
      </div>

      <!-- 入力フォーム（画面最下部に固定・スクロールしない） -->
      <div class="shrink-0 pt-2 bg-zinc-50 dark:bg-zinc-900 safe-area-padding-bottom">
        <form id="form" class="max-w-3xl">
          <div class="flex items-end gap-2">
            <div class="flex-1 min-w-0">
              <label for="input" class="sr-only">質問</label>
              <textarea
                id="input"
                rows="1"
                class="w-full resize-none rounded-xl border border-zinc-300 dark:border-zinc-700 bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-50 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-zinc-900 dark:focus:ring-zinc-100 focus:border-transparent"
                placeholder="例）お手つきのルールを教えて"
                style="min-height: 44px; max-height: 120px;"
              ></textarea>
            </div>
            <button
              type="submit"
              id="sendButton"
              class="inline-flex items-center justify-center rounded-xl bg-zinc-900 dark:bg-zinc-100 h-[44px] w-[44px] min-h-[44px] text-white dark:text-zinc-900 hover:bg-zinc-800 dark:hover:bg-zinc-200 disabled:opacity-50 disabled:cursor-not-allowed transition shrink-0"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                <path d="M5 12L3 4l18 8-18 8 2-8zm0 0l7 4-2-4 2-4-7 4z" />
              </svg>
            </button>
          </div>
          <p class="mt-1.5 text-[10px] sm:text-xs text-zinc-400 dark:text-zinc-500 text-center">
            回答は競技規定・競技細則・競技会規定に基づきます。AIは間違えることがあります。必ずご自身でもルールを確認してください。
          </p>
        </form>
      </div>
    </div>

    <!-- シェア用トースト -->
    <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg bg-zinc-800 dark:bg-zinc-200 text-white dark:text-zinc-900 text-sm opacity-0 pointer-events-none transition-opacity z-50" role="status" aria-live="polite">
      コピーしました
    </div>

    <script>
      const chat = document.getElementById("chat");
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const sendButton = document.getElementById("sendButton");
      const toast = document.getElementById("toast");

      // 一連の会話（シェア用URL発行に使用）
      var conversationHistory = [];

      if (sendButton && input) sendButton.style.height = input.offsetHeight + "px";

      // Markdown を安全に HTML に変換
      function renderMarkdown(text) {
        var raw = String(text || "").trim();
        if (!raw) return "";
        if (typeof marked === "undefined" || typeof DOMPurify === "undefined") {
          return escapeHtml(raw).replace(/\n/g, "<br>");
        }
        var html = (marked.parse || marked)(raw, { gfm: true, breaks: true });
        return DOMPurify.sanitize(html, { ALLOWED_TAGS: ["p","br","strong","em","code","pre","ul","ol","li","h1","h2","h3","a","blockquote"] });
      }

      function showToast(message) {
        if (!toast) return;
        toast.textContent = message;
        toast.classList.remove("opacity-0");
        setTimeout(function() { toast.classList.add("opacity-0"); }, 2000);
      }

      function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(function() { showToast("コピーしました"); });
        } else {
          var ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          showToast("コピーしました");
        }
      }

      function shareConversationAsUrl(clickedBtn) {
        if (conversationHistory.length === 0) return;
        if (clickedBtn) { clickedBtn.disabled = true; }
        fetch("/api/share", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: conversationHistory })
        })
          .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
          .then(function(result) {
            if (!result.ok) {
              showToast(result.data.error || "発行に失敗しました");
              if (clickedBtn) clickedBtn.disabled = false;
              return;
            }
            var url = result.data.url;
            if (navigator.share && /mobile|android|iphone|ipad/i.test(navigator.userAgent)) {
              navigator.share({
                title: "競技かるたRAG - 会話",
                text: "競技かるたRAGの会話をシェアしました",
                url: url
              }).then(function() { showToast("シェアしました"); }).catch(function() {
                copyToClipboard(url);
                showToast("URLをコピーしました");
              });
            } else {
              copyToClipboard(url);
              showToast("URLをコピーしました");
            }
            if (clickedBtn) clickedBtn.disabled = false;
          })
          .catch(function() {
            showToast("発行に失敗しました");
            if (clickedBtn) clickedBtn.disabled = false;
          });
      }

      function appendUserMessage(text) {
        var placeholder = document.getElementById("chat-placeholder");
        if (placeholder && placeholder.parentNode) placeholder.remove();
        var wrapper = document.createElement("div");
        wrapper.className = "flex justify-end";
        wrapper.innerHTML = '<div class="max-w-[85%] sm:max-w-[80%] rounded-2xl bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 px-3 py-2 text-sm shadow"><div>' + escapeHtml(text) + '</div></div>';
        chat.appendChild(wrapper);
      }

      function appendAssistantMessage(question, text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex justify-start";
        const trimmedText = String(text || "").trim().split('\n').map(function(l) { return l.trimStart(); }).join('\n');
        const html = renderMarkdown(trimmedText);

        const container = document.createElement("div");
        container.className = "flex items-start gap-2 max-w-[85%] sm:max-w-[80%]";
        const avatar = document.createElement("div");
        avatar.className = "mt-1 h-6 w-6 shrink-0 rounded-full bg-zinc-900 dark:bg-zinc-100 text-xs flex items-center justify-center text-white dark:text-zinc-900";
        avatar.textContent = "K";
        const contentWrap = document.createElement("div");
        contentWrap.className = "flex-1 min-w-0";
        const messageDiv = document.createElement("div");
        messageDiv.className = "markdown-body rounded-2xl bg-zinc-100 dark:bg-zinc-800 px-3 py-2 text-sm text-zinc-900 dark:text-zinc-50";
        messageDiv.innerHTML = html || escapeHtml(trimmedText);

        const shareBtn = document.createElement("button");
        shareBtn.type = "button";
        shareBtn.className = "mt-1 text-xs text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-300 flex items-center gap-1";
        shareBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> 会話をURLでシェア';
        shareBtn.addEventListener("click", function() { shareConversationAsUrl(shareBtn); });

        contentWrap.appendChild(messageDiv);
        contentWrap.appendChild(shareBtn);
        container.appendChild(avatar);
        container.appendChild(contentWrap);
        wrapper.appendChild(container);
        chat.appendChild(wrapper);
        conversationHistory.push({ question: question, answer: text });
      }

      function appendLoadingBubble() {
        const wrapper = document.createElement("div");
        wrapper.className = "flex justify-start";
        wrapper.innerHTML = `
          <div class="flex items-start gap-2 max-w-[80%]">
            <div class="mt-1 h-6 w-6 shrink-0 rounded-full bg-zinc-900 dark:bg-zinc-100 text-xs flex items-center justify-center text-white dark:text-zinc-900">
              K
            </div>
            <div class="rounded-2xl bg-zinc-100 dark:bg-zinc-800 px-3 py-2 text-sm text-zinc-500 dark:text-zinc-400 flex items-center gap-2">
              <span>考え中…</span>
              <span class="flex gap-1">
                <span class="h-1.5 w-1.5 rounded-full bg-zinc-400 dark:bg-zinc-500 animate-bounce"></span>
                <span class="h-1.5 w-1.5 rounded-full bg-zinc-400 dark:bg-zinc-500 animate-bounce [animation-delay:0.1s]"></span>
                <span class="h-1.5 w-1.5 rounded-full bg-zinc-400 dark:bg-zinc-500 animate-bounce [animation-delay:0.2s]"></span>
              </span>
            </div>
          </div>
        `;
        chat.appendChild(wrapper);
        return wrapper;
      }

      function scrollToBottom() {
        chat.scrollTop = chat.scrollHeight;
      }

      // レートリミット到達時用の通知をチャットに表示
      function appendRateLimitNotice(message) {
        var placeholder = document.getElementById("chat-placeholder");
        if (placeholder && placeholder.parentNode) placeholder.remove();
        var wrapper = document.createElement("div");
        wrapper.className = "flex justify-center my-2";
        wrapper.innerHTML =
          '<div class="max-w-[85%] rounded-xl border-2 border-amber-400 dark:border-amber-500 bg-amber-50 dark:bg-amber-950/50 px-4 py-3 text-sm text-amber-900 dark:text-amber-100">' +
          '<p class="font-medium">1日あたりの質問回数の上限に達しました</p>' +
          '<p class="mt-1 text-xs opacity-90">' + escapeHtml(message || "明日またお試しください。") + '</p>' +
          '</div>';
        chat.appendChild(wrapper);
      }

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const q = input.value.trim();
        if (!q) return;

        appendUserMessage(q);
        input.value = "";
        input.style.height = "42px";
        sendButton.style.height = "42px";

        // ローディング表示
        const loadingBubble = appendLoadingBubble();
        scrollToBottom();

        sendButton.disabled = true;

        try {
          const res = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: q }),
            credentials: "include",
          });

          const data = await res.json().catch(function() { return {}; });

          // レートリミット（429）のときは専用メッセージを表示
          if (res.status === 429) {
            chat.removeChild(loadingBubble);
            var msg = (data && data.message) ? data.message : "1日あたりの質問回数の上限に達しました。明日またお試しください。";
            appendRateLimitNotice(msg);
            showToast(msg);
            sendButton.disabled = false;
            scrollToBottom();
            return;
          }

          // ローディングを消してから回答バブルを追加
          chat.removeChild(loadingBubble);
          var ans = (data && typeof data.answer === "string") ? data.answer : "エラーが発生しました。";
          appendAssistantMessage(q, ans);
        } catch (err) {
          chat.removeChild(loadingBubble);
          appendAssistantMessage(q, "ネットワークエラーが発生しました。");
        } finally {
          sendButton.disabled = false;
          scrollToBottom();
        }
      });

      // テキストエリアの自動リサイズ
      input.addEventListener("input", () => {
        input.style.height = "auto";
        const newHeight = Math.max(42, input.scrollHeight);
        input.style.height = newHeight + "px";
        // ボタンの高さも合わせる
        sendButton.style.height = newHeight + "px";
      });

      // Enter で送信（Shift+Enter で改行）
      // 日本語入力中（変換中）は isComposing / keyCode 229 を見て無視する
      input.addEventListener("keydown", (e) => {
        if (e.isComposing || e.keyCode === 229) {
          return;
        }
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          const q = input.value.trim();
          if (!q) return;
          
          // 入力欄をクリア
          input.value = "";
          input.style.height = "42px";
          sendButton.style.height = "42px";
          
          // フォーム送信を実行
          appendUserMessage(q);
          const loadingBubble = appendLoadingBubble();
          scrollToBottom();
          sendButton.disabled = true;

          fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: q }),
            credentials: "include",
          })
            .then(function(res) {
              return res.json().catch(function() { return {}; }).then(function(data) { return { status: res.status, data: data }; });
            })
            .then(function(result) {
              chat.removeChild(loadingBubble);
              if (result.status === 429) {
                var msg = (result.data && result.data.message) ? result.data.message : "1日あたりの質問回数の上限に達しました。明日またお試しください。";
                appendRateLimitNotice(msg);
                showToast(msg);
                return;
              }
              var ans = (result.data && typeof result.data.answer === "string") ? result.data.answer : "エラーが発生しました。";
              appendAssistantMessage(q, ans);
            })
            .catch(function(err) {
              chat.removeChild(loadingBubble);
              appendAssistantMessage(q, "ネットワークエラーが発生しました。");
            })
            .finally(() => {
              sendButton.disabled = false;
              scrollToBottom();
            });
        }
      });
    </script>
  </body>
</html>
